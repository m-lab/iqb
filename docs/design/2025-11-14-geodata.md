# Geodata Field Availability in M-Lab BigQuery

**Date:** 2025-11-14
**Status:** Implemented (city/subdivision queries used throughout IQB pipeline)

## Question

Which geodata fields in `measurement-lab.ndt.unified_downloads` are
actually populated? If only country and lat/lon are filled, IQB queries
need spatial operations (bounding boxes, point-in-polygon) to aggregate
by city or region. If city and subdivision fields are filled, simple
`GROUP BY` clauses suffice.

## Method

Queried a 1% random sample of October 2024 data (1,413,218 rows out of
~141M total). At this sample size, 95% confidence intervals have margins
of error <0.1% for all fields.

## Results

| Field | Fill Rate | Notes |
|-------|-----------|-------|
| ContinentCode | 99.95% | |
| CountryCode | 99.92% | 2-letter ISO |
| CountryName | 99.92% | |
| **Subdivision1ISOCode** | **92.95%** | State/province code |
| **Subdivision1Name** | **92.95%** | State/province name |
| **City** | **90.14%** | |
| PostalCode | 82.08% | |
| Latitude | 99.95% | |
| Longitude | 99.95% | |
| AccuracyRadiusKm | 99.95% | |
| Subdivision2ISOCode | 13.03% | County/district — too sparse |
| Subdivision2Name | 13.03% | County/district — too sparse |
| MetroCode | 21.20% | Too sparse |
| CountryCode3 | 0% | Empty |
| Region | 0% | Empty |
| AreaCode | 0% | Empty |

## Decision

City (90%) and subdivision1 (93%) fill rates are high enough to use
directly as `GROUP BY` columns. No spatial operations needed. This
finding enabled the six aggregation levels used throughout the IQB
pipeline: `country`, `country_asn`, `country_province`,
`country_province_asn`, `country_city`, `country_city_asn`.

~10% of measurements lack city info. For regions with good M-Lab
coverage, the actual loss is likely lower. A minimum sample-count
filter (e.g., ≥100 measurements per group) handles sparse cells.
